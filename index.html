<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>choose-your-own-adventure â€” Web</title>
  <meta name="description" content="Play the choose-your-own-adventure CLI game in the browser (React, optimized)"/>
  <style>
    :root{--bg:#071024;--card:#082034;--accent:#06b6d4;--muted:#9fb6c6;color-scheme:dark}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071024 0%, #021025 100%);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:#e6edf3}
    a{color:var(--accent)}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{width:100%;max-width:980px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.04));border-radius:12px;padding:20px;box-shadow:0 12px 40px rgba(2,6,23,.6);border:1px solid rgba(255,255,255,0.03)}
    header{display:flex;gap:12px;align-items:center;margin-bottom:10px}
    .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#0ea5a4);display:flex;align-items:center;justify-content:center;font-weight:700;color:#00223a}
    h1{margin:0;font-size:1.25rem}
    .meta{color:var(--muted);font-size:.95rem;margin-top:6px}
    .preview{width:100%;max-height:220px;object-fit:cover;border-radius:8px;margin:12px 0}
    .game{display:grid;grid-template-columns:1fr 300px;gap:16px}
    @media (max-width:880px){.game{grid-template-columns:1fr}}
    .scene{background:rgba(255,255,255,0.02);padding:16px;border-radius:10px;min-height:220px;display:flex;flex-direction:column;gap:12px;position:relative;overflow:hidden}
    .text{font-size:1.03rem;line-height:1.5}
    .choices{display:flex;flex-direction:column;gap:10px;margin-top:auto}
    button.choice{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.06));border:1px solid rgba(255,255,255,0.03);padding:10px 12px;border-radius:8px;color:inherit;text-align:left;cursor:pointer;transition:transform .15s,box-shadow .15s,opacity .18s}
    button.choice:hover{transform:translateY(-4px);box-shadow:0 14px 30px rgba(2,6,23,.45)}
    button.choice:focus{outline:3px solid rgba(6,182,212,0.18);outline-offset:3px}
    aside{background:rgba(0,0,0,0.03);padding:14px;border-radius:10px;min-height:220px;display:flex;flex-direction:column;gap:10px}
    .history{font-size:.95rem;color:var(--muted);max-height:160px;overflow:auto}
    .controls{display:flex;gap:8px;margin-top:12px}
    .btn{padding:8px 10px;border-radius:8px;background:var(--accent);color:#00223a;border:none;cursor:pointer}
    .small{font-size:.9rem;padding:6px 8px}
    footer{margin-top:16px;color:var(--muted);font-size:.9rem;text-align:center}
    .badge{height:20px;margin-right:6px;vertical-align:middle}
    /* transitions */
    .fade-enter{opacity:0;transform:translateY(6px)}
    .fade-enter-active{opacity:1;transform:none;transition:opacity .28s ease,transform .28s ease}
    .scene-header{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .choice-key{font-weight:700;color:var(--muted);margin-right:8px}
    /* reduced motion */
    @media (prefers-reduced-motion: reduce) {
      button.choice, .fade-enter-active{transition:none}
    }
    /* small accessibility skip link */
    .skip{position:absolute;left:-999px;top:auto;width:1px;height:1px;overflow:hidden}
    .skip:focus{left:8px;top:8px;width:auto;height:auto;padding:8px;background:#fff;color:#000;border-radius:6px}
  </style>
</head>
<body>
  <a class="skip" href="#game">Skip to game</a>
  <div class="wrap">
    <div class="card" role="main">
      <header>
        <div class="logo" aria-hidden="true">CYOA</div>
        <div>
          <h1>ðŸŽ² choose-your-own-adventure â€” Web</h1>
          <div class="meta">React CDN (production) Â· keyboard shortcuts Â· save progress Â· accessible</div>
        </div>

        <!-- Theme toggle -->
        <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
          <button id="themeToggle" aria-label="Toggle theme" class="btn small" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit">ðŸŒ™</button>
        </div>
      </header>

      <img class="preview" src="https://media.giphy.com/media/3o7TKtnuHOHHUjR38Y/giphy.gif" alt="preview animation">

      <div id="root" aria-live="polite"></div>

      <footer>
        <img class="badge" src="https://img.shields.io/badge/python-3.8%2B-blue" alt="python">
        <img class="badge" src="https://img.shields.io/badge/license-MIT-green" alt="license">
        &nbsp; â€¢ Live: <a href="https://vannu07.github.io/choose-your-own-adventure" target="_blank" rel="noopener">vannu07.github.io/choose-your-own-adventure</a>
      </footer>
    </div>
  </div>

  <!-- Production React (fast) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <script>
    (function () {
      const { createElement: h, useState, useEffect, useRef } = React;
      const STORAGE_KEY = 'cyoa_state_v1';

      const FALLBACK_STORY = {
        start: { id: 'start', title: 'A Dark Forest', text: "You wake in a dark forest. Two paths lie ahead.", choices: [{id:'left',label:'Left path'},{id:'right',label:'Right path'}] },
        left: { id:'left', title:'Abandoned Cabin', text:"You see a cabin. A light in the window.", choices:[{id:'enter',label:'Enter'},{id:'start',label:'Return'}] },
        right: { id:'right', title:'Rushing River', text:"A river blocks the path.", choices:[{id:'cross',label:'Cross the bridge'},{id:'start',label:'Return'}] },
        enter: { id:'enter', title:'Warm Hearth', text:"A warm fire. You are safe.", choices:[{id:'end',label:'Rest (End)'}] },
        cross: { id:'cross', title:'On the Other Side', text:"A small village appears.", choices:[{id:'end',label:'Celebrate (End)'}]},
        end: { id:'end', title:'The End', text:'Thanks for playing.', choices:[{id:'start',label:'Play again'}]}
      };

      async function loadStory() {
        try {
          const res = await fetch('./story.json', {cache: 'no-cache'});
          if (!res.ok) throw new Error('no story.json');
          const json = await res.json();
          return json;
        } catch (e) {
          return FALLBACK_STORY;
        }
      }

      function getQueryScene() {
        try { const p = new URLSearchParams(location.search); return p.get('scene'); } catch { return null; }
      }

      function saveState(state) {
        try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch {}
      }
      function loadState() {
        try { const s = localStorage.getItem(STORAGE_KEY); return s ? JSON.parse(s) : null; } catch { return null; }
      }

      function App() {
        const [story, setStory] = useState(null);
        const [sceneId, setSceneId] = useState('start');
        const [history, setHistory] = useState([]);
        const [animKey, setAnimKey] = useState(0);
        const choicesRef = useRef(null);

        useEffect(() => {
          let mounted = true;
          loadStory().then(s => { if (mounted) setStory(s); });
          const saved = loadState();
          const q = getQueryScene();
          if (q) setSceneId(q);
          else if (saved && saved.sceneId) { setSceneId(saved.sceneId); setHistory(saved.history || []); }
          return () => { mounted = false; };
        }, []);

        useEffect(() => {
          const btn = choicesRef.current && choicesRef.current.querySelector('button');
          if (btn) btn.focus();
        }, [sceneId, story]);

        useEffect(() => {
          saveState({ sceneId, history });
          setAnimKey(k => k + 1);
        }, [sceneId]);

        useEffect(() => {
          function onKey(e) {
            if (!story) return;
            const scene = resolveScene(sceneId, story);
            if (!scene || !scene.choices) return;
            if (e.key === 'Enter') { scene.choices[0] && go(scene.choices[0].id); }
            if (/^[1-9]$/.test(e.key)) {
              const idx = parseInt(e.key,10) - 1;
              const c = scene.choices[idx];
              if (c) go(c.id);
            }
          }
          window.addEventListener('keydown', onKey);
          return () => window.removeEventListener('keydown', onKey);
        }, [story, sceneId, history]);

        function resolveScene(id, s) {
          const S = s || story || FALLBACK_STORY;
          const item = S[id];
          if (!item) return S.start;
          if (item.redirect) return S[item.redirect] || S.start;
          return item;
        }

        function go(choiceId) {
          const S = story || FALLBACK_STORY;
          const next = resolveScene(choiceId, S);
          setHistory(h => [...h, { id: resolveScene(sceneId, S).id, title: resolveScene(sceneId, S).title }]);
          setSceneId(next.id || 'start');
          try { const u = new URL(location.href); u.searchParams.set('scene', next.id); history.pushState({},'',u); } catch {}
        }

        function restart() {
          setHistory([]);
          setSceneId('start');
          try { const u = new URL(location.href); u.searchParams.delete('scene'); history.pushState({},'',u); } catch {}
        }

        if (!story) {
          return h('div', {id:'game'}, h('div',{className:'game',id:'game'}, h('div',{className:'scene'}, 'Loading...')));
        }

        const scene = resolveScene(sceneId, story);

        return h('div', {className:'game', id:'game', role:'application', 'aria-label':'Choose your own adventure'},
          h('div', {className:'scene fade-enter fade-enter-active', key:animKey},
            h('div', {className:'scene-header'},
              h('div',{style:{fontSize:'.95rem',color:'var(--muted)'}}, scene.title || 'Untitled'),
              h('div',{style:{fontSize:'.85rem',color:'var(--muted)'}}, `Scene: ${scene.id}`)
            ),
            h('div',{className:'text'}, scene.text),
            h('div',{className:'choices', ref:choicesRef},
              (scene.choices || []).map((c, i) => {
                const label = c.label || c.id;
                const keyLabel = (i < 9) ? (i + 1) + '. ' : '';
                return h('button', {
                  key: c.id + '-' + i,
                  className: 'choice',
                  onClick: () => go(c.id),
                  'aria-label': label
                }, h('span',{className:'choice-key'}, keyLabel), label);
              })
            ),
            h('div',{className:'controls'},
              h('button',{className:'btn small', onClick: () => { navigator.clipboard?.writeText(location.href); }}, 'Copy URL'),
              h('button',{className:'btn small', onClick: restart}, 'Restart')
            )
          ),
          h('aside', {role:'complementary'},
            h('div',{style:{fontWeight:700}}, 'History'),
            h('div',{className:'history', 'aria-live':'polite'}, history.length === 0 ? h('div',{style:{color:'var(--muted)'}}, 'No moves yet') : history.map((hitem, idx) => h('div',{key:idx}, 'â†’ ' + (hitem.title || hitem.id)))),
            h('div',{style:{marginTop:8, fontSize:'.9rem', color:'var(--muted)'}},
              h('div',{style:{fontWeight:700, marginBottom:6}}, 'About'),
              h('div', null, 'Keyboard: numbers 1-9 to pick choices, Enter to choose first. Progress saved locally. To use a custom story: add docs/story.json with the story map (same shape as demo).')
            )
          )
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(h(App));
    })();
  </script>

  <script>
    // Theme toggle: persists in localStorage
    (function () {
      const key = 'cyoa_theme';
      const btn = document.getElementById('themeToggle');
      function applyTheme(t) {
        if (t === 'light') {
          document.documentElement.style.setProperty('--bg','#f7fafc');
          document.documentElement.style.setProperty('--card','#ffffff');
          document.documentElement.style.setProperty('--accent','#0ea5a4');
          document.documentElement.style.setProperty('--muted','#374151');
          document.body.style.color = '#0b1220';
        } else {
          document.documentElement.style.setProperty('--bg','#071024');
          document.documentElement.style.setProperty('--card','#082034');
          document.documentElement.style.setProperty('--accent','#06b6d4');
          document.documentElement.style.setProperty('--muted','#9fb6c6');
          document.body.style.color = '';
        }
        btn.textContent = t === 'light' ? 'â˜€ï¸' : 'ðŸŒ™';
      }
      const saved = localStorage.getItem(key) || (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
      applyTheme(saved);
      btn.addEventListener('click', () => {
        const next = (localStorage.getItem(key) === 'light') ? 'dark' : 'light';
        localStorage.setItem(key, next);
        applyTheme(next);
      });
    })();

    // Register service worker (if available)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(() => {/* ignore */});
    }
  </script>
</body>
</html>